## Docker Compose para OpenClaw OS
##
## Uso:
##   docker compose up -d           # sobe o ambiente
##   docker compose exec openclaw openclaw doctor  # diagnóstico
##   docker compose logs -f         # acompanha logs
##
## Variáveis de ambiente (veja .env.example):
##   OPENCLAW_TOKEN  — token de autenticação (obrigatório)
##   OPENCLAW_BIND   — endereço de bind (padrão: 127.0.0.1)
##   OPENCLAW_PORT   — porta do gateway (padrão: 18789)

services:
  openclaw:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: openclaw
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - OPENCLAW_TOKEN=${OPENCLAW_TOKEN:-}
      - OPENCLAW_BIND=${OPENCLAW_BIND:-127.0.0.1}
      - OPENCLAW_PORT=${OPENCLAW_PORT:-18789}
    volumes:
      ## Workspace do projeto — mapeado para persistência
      - ./workspace:/workspace
      ## Logs de auditoria — mapeados para host
      - ./logs:/var/log/openclaw
    working_dir: /workspace
    ports:
      - "${OPENCLAW_BIND:-127.0.0.1}:${OPENCLAW_PORT:-18789}:18789"
    healthcheck:
      test: ["CMD", "node", "-e", "require('net').createConnection({port:18789}).on('error',()=>process.exit(1)).on('connect',()=>process.exit(0))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    ## Limites de recursos para produção
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "1.0"
        reservations:
          memory: 128M
    ## Segurança: sem privilégios extras
    security_opt:
      - no-new-privileges:true
    read_only: false

  ## WireGuard VPN (opcional — descomentar para uso com VPN)
  # wireguard:
  #   image: linuxserver/wireguard:latest
  #   container_name: openclaw-wireguard
  #   cap_add:
  #     - NET_ADMIN
  #     - SYS_MODULE
  #   environment:
  #     - PUID=1000
  #     - PGID=1000
  #   volumes:
  #     - ./wireguard:/config
  #   ports:
  #     - "51820:51820/udp"
  #   sysctls:
  #     - net.ipv4.conf.all.src_valid_mark=1
  #   restart: unless-stopped
